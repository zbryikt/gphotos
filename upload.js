var x$;x$=angular.module("main"),x$.controller("upload",["$scope","$interval","$timeout","$firebaseArray","$firebaseAuth","backend"].concat(function(e,n,r,t,a,o){var s;return e.stream=o.stream,e.user=o.user,e.upload={concurrentCount:2,progress:{},queue:[],current:[],url:"/d/pic",_handler:function(n){var r,t,a=this;return r=/\.([^.]+)$/.exec(n.name),r||(t="image/jpeg"),"jpg"===r[1]&&(t="image/jpeg"),t="image/"+r[1],storage.upload(n,n.name,t,n.base64,function(n,r){return e.$apply(function(){return console.log("[PROGRESS] "+n.name+" / LOADED: "+r.loaded+" / TOTAL: "+r.total+" / SIZE: "+n.size),n.size=r.total,n.progress=r.loaded})}).then(function(){var r,t,o,s=[];for(console.log("[UPLOADED] "+n.name+" ("+n.size+")"),n.progress=n.size,r=0,t=a.current.length;t>r;++r)if(o=r,a.current[o].name===n.name){e.stream.$add({name:a.current[o].name,url:"https://storage.googleapis.com/thumbnail-gphotos/"+a.current[o].name}),a.current.splice(o,1),e.upload.handle();break}return s})},handle:function(e){var n,r,t,a,o,s,l=[];if(null==e&&(e=null),e&&(n=JSON.stringify(e),this.progress[e[0]]=r={name:e[0],size:n.length,data:n,base64:e[1],img:"data:image/png;base64,"+e[1]},this.queue.push(r),console.log("[QUEUEED] "+e[0])),!(this.current.length>=this.concurrentCount)){for(this.current=this.current.concat(this.queue.splice(0,2-this.current.length)),t=0,o=(a=this.current).length;o>t;++t)s=a[t],console.log("[PROCESS] "+s.name),l.push(this._handler(s));return l}}},s=function(n){var r;return console.log("load file "+n.name+" ... "),r=new FileReader,r.onload=function(){return n.name=encodeURIComponent(n.name),e.upload.handle([n.name,btoa(r.result)])},r.readAsBinaryString(n)},$("#files").on("change",function(){var e,n,r,t,a,o,l=[];for(e=$("#files")[0],console.log("[UPLOAD] "+e.files.length+" files.."),n=[],r=0,t=e.files.length;t>r;++r)a=r,o=e.files[a],l.push(s(o));return l}),storage.init()}));