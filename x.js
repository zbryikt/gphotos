$scope.upload={concurrentCount:2,progress:{},queue:[],current:[],url:"/d/pic",_handler:function(e){var n,r,t=this;return n=/\.([^.]+)$/.exec(e.name),n||(r="image/jpeg"),"jpg"===n[1]&&(r="image/jpeg"),r="image/"+n[1],storage.upload(e.name,r,e.base64,function(n){return $scope.$apply(function(){return e.progress=n.loaded})}).then(function(){var n,r,a,u=[];for(e.progress=e.size,n=0,r=t.current.length;r>n;++n)if(a=n,t.current[a].name===e.name){$scope.stream.$add({name:t.current[a].name,url:"https://storage.googleapis.com/thumbnail-gphotos/"+t.current[a].name}),t.current.splice(a,1),$scope.upload.handle();break}return u})},handle:function(e){var n,r,t,a,u,s,o=[];if(null==e&&(e=null),e&&(n=JSON.stringify(e),this.progress[e[0]]=r={name:e[0],size:n.length,data:n,base64:e[1],img:"data:image/png;base64,"+e[1]},this.queue.push(r)),!(this.current.length>=this.concurrentCount)){for(this.current=this.current.concat(this.queue.splice(0,2-this.current.length)),t=0,u=(a=this.current).length;u>t;++t)s=a[t],console.log("handle "+s.name+"..."),o.push(this._handler(s));return o}}};