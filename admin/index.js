function repeatString$(t,n){for(var e="";n>0;(n>>=1)&&(t+=t))1&n&&(e+=t);return e}function import$(t,n){var e={}.hasOwnProperty;for(var r in n)e.call(n,r)&&(t[r]=n[r]);return t}var x$;x$=angular.module("main"),x$.filter("formatdate",function(){return function(t){var n,e,r,i,a,o,u;return t?(n=new Date(t),e=function(t){return(t+"").length<2?"0"+t:t+""},r=e(n.getMonth()+1),i=e(n.getDate()),a=e(n.getHours()),o=e(n.getMinutes()),u=e(n.getSeconds()),r+"/"+i+" "+a+":"+o+":"+u):"N/A"}}),x$.controller("admin",["$scope","$interval","$timeout","$firebaseArray","$firebaseAuth","backend"].concat(function(t,n,e,r,i,a){return t.stream=a.stream,t.user=a.user,t.backend=a,a.email("admin@tw-events.com","admin").then(function(r){return t.admin=r,t.vote={start:a.config.start||null,getstart:function(){return this.start=(new Date).getTime(),a.config.start=this.start,a.config.$save()},dur:a.config.dur||120,update:function(){return a.config.dur=this.dur,a.config.$save()}},t.backend=a,t.$watch("backend.config.start",function(){return t.vote.start=a.config.start}),t.$watch("backend.config.dur",function(){return t.vote.dur=a.config.dur}),t.$watch("backend.config",function(){return t.vote.start=a.config.start||null,t.vote.dur=a.config.dur||120}),t.upload={concurrentCount:2,progress:{},queue:[],current:[],url:"/d/pic",_handler:function(n){var e=this;return storage.upload(n,n.name,n.type,n.base64,function(n,e){return t.$apply(function(){return console.log("[PROGRESS] "+n.name+" / LOADED: "+e.loaded+" / TOTAL: "+e.total+" / SIZE: "+n.size),n.size=e.total,n.progress=e.loaded})}).then(function(){var r,i,a,o,u=[];for(console.log("[UPLOADED] "+n.name+" ("+n.size+")"),n.progress=n.size,n.loaded=!0,r=function(t){return(t+"").length<6?repeatString$("0",6-(t+"").length)+(t+""):t+""},i=0,a=e.current.length;a>i;++i)if(o=i,e.current[o].name===n.name){t.stream.$add({name:e.current[o].name,url:"https://storage.googleapis.com/thumbnail-gphotos/"+e.current[o].name,order:r(t.stream.length)}),e.current.splice(o,1),t.upload.handle();break}return u})},handle:function(t){var n,e,r,i,a=[];if(null==t&&(t=null),t&&(this.queue.push(this.progress[t[0]]),console.log("[QUEUEED] "+t[0])),!(this.current.length>=this.concurrentCount)){for(this.current=this.current.concat(this.queue.splice(0,2-this.current.length)),n=0,r=(e=this.current).length;r>n;++n)i=e[n],console.log("[PROCESS] "+i.name),a.push(this._handler(i));return a}},sizing:[],startConsumerHandle:null,start:function(t){var e,r,i=this;return t.name=encodeURIComponent(t.name),e="image/jpeg",r=/\.([^.]+)$/.exec(t.name),r&&"jpg"!==r[1]&&(e="image/"+r[1]),this.progress[t.name]={name:t.name,size:0,type:e,file:t,img:"/img/default.gif"},this.sizing.push(this.progress[t.name]),this.startConsumerHandle?void 0:this.startConsumerHandle=n(function(){return i.startConsumer()},1e3)},startConsumer:function(){var t;return this.sizing=this.sizing.filter(function(t){return!t.resized}),t=this.sizing.filter(function(t){return t.resizing}),!t.length&&this.sizing.length?this.loadfile(this.sizing[0]):void 0},loadfile:function(n){var e,r=this;return console.log("load file "+n.name+" ... "),n.resizing=!0,e=new FileReader,e.onload=function(){return t.image.frombin(e.result,n.type).then(function(i){return t.image.resize(i,480).then(function(i){var a,o,u,s;return a=atob(i.substring(i.indexOf(",")+1)),console.log(["[RESIZE] "+n.name+" ","from: "+parseInt(e.result.length/1e3)+"KB ","to: "+parseInt(a.length/1e3)+"KB"].join("")),o=new Image,o.src=i,u=[n.name,"image/jpeg",btoa(a)],s=JSON.stringify(u),import$(r.progress[n.name],{data:s,base64:u[2],img:"data:"+u[1]+";base64,"+u[2],resized:!0,resizing:!1}),t.upload.handle(u)})})},e.readAsBinaryString(n.file)}},$("#files").on("change",function(){var n,e,r,i,a,o,u,s=[];for(n=$("#files")[0],console.log("[UPLOAD] "+n.files.length+" files.."),e=[],r=function(n){return t.$apply(function(){return t.upload.start(n)})},i=0,a=n.files.length;a>i;++i)o=i,u=n.files[o],s.push(r(u));return s}),t.image={init:function(){return this.input=document.createElement("canvas"),this.output=document.createElement("canvas"),this.inctx=this.input.getContext("2d"),this.outctx=this.input.getContext("2d")},resize:function(t,n,e){var r=this;return new Promise(function(i){var a,o,u,s,c,g;return n?e=n/t.width*t.height:e?n=e/t.height*t.width:(a=[t.width,t.height],n=a[0],e=a[1]),a=[t.width,t.height,n,e],o=a[0],u=a[1],s=a[2],c=a[3],(g=function(t,n,e){var a,o,u,l,h,f;return a=s>=n/2||c>=e/2?!0:!1,o=a?s:n/2,u=a?c:e/2,l=r.input,l.width=o,l.height=u,r.inctx.drawImage(t,0,0,o,u),a?(h=r.input.toDataURL("image/jpeg",.85),i(h)):(h=r.input.toDataURL("image/jpeg",1),f=new Image,f.onload=function(){return g(f,o,u)},f.src=h)})(t,o,u)})},frombin:function(t,n){return new Promise(function(e){var r;return r=new Image,r.onload=function(){return e(r)},r.src="data:"+n+";base64,"+btoa(t)})}},t.image.init(),storage.init().then(function(){return t.inited=!0}),e(function(){return t.inited?void 0:t.hint2=!0},1e4),t.trash=function(t){return a.stream.$remove(t)}})}));