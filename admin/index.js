function repeatString$(t,e){for(var n="";e>0;(e>>=1)&&(t+=t))1&e&&(n+=t);return n}function import$(t,e){var n={}.hasOwnProperty;for(var r in e)n.call(e,r)&&(t[r]=e[r]);return t}var x$;x$=angular.module("main"),x$.filter("formatdate",function(){return function(t){var e,n,r,i,a,o,s;return t?(e=new Date(t),n=function(t){return(t+"").length<2?"0"+t:t+""},r=n(e.getMonth()+1),i=n(e.getDate()),a=n(e.getHours()),o=n(e.getMinutes()),s=n(e.getSeconds()),r+"/"+i+" "+a+":"+o+":"+s):"N/A"}}),x$.controller("admin",["$scope","$interval","$timeout","$firebaseArray","$firebaseAuth","backend"].concat(function(t,e,n,r,i,a){return t.stream=a.stream,t.user=a.user,a.email("admin@tw-events.com","admin").then(function(n){return t.admin=n,t.vote={start:a.config.start||null,getstart:function(){return this.start?void 0:(this.start=(new Date).getTime(),a.config.start=this.start,a.config.$save())},dur:a.config.dur||120,update:function(){return a.config.dur=this.dur,a.config.$save()}},t.backend=a,t.$watch("backend.config",function(){return t.vote.start=a.config.start||null,t.vote.dur=a.config.dur||120}),t.upload={concurrentCount:2,progress:{},queue:[],current:[],url:"/d/pic",_handler:function(e){var n=this;return storage.upload(e,e.name,e.type,e.base64,function(e,n){return t.$apply(function(){return console.log("[PROGRESS] "+e.name+" / LOADED: "+n.loaded+" / TOTAL: "+n.total+" / SIZE: "+e.size),e.size=n.total,e.progress=n.loaded})}).then(function(){var r,i,a,o,s=[];for(console.log("[UPLOADED] "+e.name+" ("+e.size+")"),e.progress=e.size,e.loaded=!0,r=function(t){return(t+"").length<6?repeatString$("0",6-(t+"").length)+(t+""):t+""},i=0,a=n.current.length;a>i;++i)if(o=i,n.current[o].name===e.name){t.stream.$add({name:n.current[o].name,url:"https://storage.googleapis.com/thumbnail-gphotos/"+n.current[o].name,order:r(t.stream.length)}),n.current.splice(o,1),t.upload.handle();break}return s})},handle:function(t){var e,n,r,i,a=[];if(null==t&&(t=null),t&&(this.queue.push(this.progress[t[0]]),console.log("[QUEUEED] "+t[0])),!(this.current.length>=this.concurrentCount)){for(this.current=this.current.concat(this.queue.splice(0,2-this.current.length)),e=0,r=(n=this.current).length;r>e;++e)i=n[e],console.log("[PROCESS] "+i.name),a.push(this._handler(i));return a}},sizing:[],startConsumerHandle:null,start:function(t){var n,r,i=this;return t.name=encodeURIComponent(t.name),n="image/jpeg",r=/\.([^.]+)$/.exec(t.name),r&&"jpg"!==r[1]&&(n="image/"+r[1]),this.progress[t.name]={name:t.name,size:0,type:n,file:t,img:"/img/default.gif"},this.sizing.push(this.progress[t.name]),this.startConsumerHandle?void 0:this.startConsumerHandle=e(function(){return i.startConsumer()},1e3)},startConsumer:function(){var t;return this.sizing=this.sizing.filter(function(t){return!t.resized}),t=this.sizing.filter(function(t){return t.resizing}),!t.length&&this.sizing.length?this.loadfile(this.sizing[0]):void 0},loadfile:function(e){var n,r=this;return console.log("load file "+e.name+" ... "),e.resizing=!0,n=new FileReader,n.onload=function(){return t.image.frombin(n.result,e.type).then(function(i){return t.image.resize(i,480).then(function(i){var a,o,s,u;return a=atob(i.substring(i.indexOf(",")+1)),console.log(["[RESIZE] "+e.name+" ","from: "+parseInt(n.result.length/1e3)+"KB ","to: "+parseInt(a.length/1e3)+"KB"].join("")),o=new Image,o.src=i,s=[e.name,"image/jpeg",btoa(a)],u=JSON.stringify(s),import$(r.progress[e.name],{data:u,base64:s[2],img:"data:"+s[1]+";base64,"+s[2],resized:!0,resizing:!1}),t.upload.handle(s)})})},n.readAsBinaryString(e.file)}},$("#files").on("change",function(){var e,n,r,i,a,o,s,u=[];for(e=$("#files")[0],console.log("[UPLOAD] "+e.files.length+" files.."),n=[],r=function(e){return t.$apply(function(){return t.upload.start(e)})},i=0,a=e.files.length;a>i;++i)o=i,s=e.files[o],u.push(r(s));return u}),t.image={init:function(){return this.input=document.createElement("canvas"),this.output=document.createElement("canvas"),this.inctx=this.input.getContext("2d"),this.outctx=this.input.getContext("2d")},resize:function(t,e,n){var r=this;return new Promise(function(i){var a;return e?n=e/t.width*t.height:n?e=n/t.height*t.width:(a=[t.width,t.height],e=a[0],n=a[1]),a=r.input,a.width=t.width,a.height=t.height,r.inctx.drawImage(t,0,0,t.width,t.height),a=r.output,a.width=e,a.height=n,canvasResize(r.input,r.output,function(){return i(r.output.toDataURL("image/jpeg",.85))})})},frombin:function(t,e){return new Promise(function(n){var r;return r=new Image,r.onload=function(){return n(r)},r.src="data:"+e+";base64,"+btoa(t)})}},t.image.init(),storage.init()})}));